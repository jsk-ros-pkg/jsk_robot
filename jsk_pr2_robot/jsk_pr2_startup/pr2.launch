<launch>
  <node pkg="jsk_robot_startup" type="start_launch_sound.py"
        name="start_launch_sound" />
  <arg name="map_frame" default="eng2" />
  <arg name="launch_map" default="true" />
  <arg name="launch_kinect" default="true" />
  <arg name="launch_move_base" default="true" />
  <arg name="launch_moveit" default="false" />
  <arg name="launch_imagesift" default="false" />
  <arg name="launch_facedetection" default="false" />
  <arg name="launch_mjpeg_server" default="false" />
  <arg name="launch_gripper_sensor" default="true" />
  <arg name="launch_virtual_force" default="true" />
  <arg name="launch_safety_warning" default="true" />
  <arg name="launch_tablet" default="false" />
  <arg name="launch_jsk_pcl" default="false" />
  <arg name="launch_db" default="true" />
  <arg name="launch_microphone" default="true" />
  <arg name="launch_teleoperation" default="false" />
  <arg name="launch_people_detection" default="false" />
  <arg name="launch_look_forward" default="true" />
  <arg name="launch_twitter" default="true" />
  <arg name="launch_visualize_log" default="false" />
  <arg name="launch_reset_motors" default="true" />
  <arg name="slow_camera_framerate" default="true" />
  <arg name="launch_c3_startup" default="false" />
  <arg name="use_map_keepout" default="true"
       doc="whether to use keepout map or not for navigation (default: true)"/>
  <arg name="launch_dialogflow_task_executive" default="true"
       doc="whether launch dialogflow_task_executive or not."/>
  <arg name="launch_gdrive_server_c1" default="true"
       doc="whether launch gdrive_server on c1 or not."/>
  <arg name="launch_gdrive_server_c2" default="true"
       doc="whether launch gdrive_server on c2 or not."/>
  <arg name="USER_NAME" default="false" />

  <include file="$(find jsk_pr2_startup)/jsk_pr2.machine"
           if="$(arg launch_c3_startup)" />
  <include file="$(find pr2_machine)/$(env ROBOT).machine"
           unless="$(arg launch_c3_startup)" />
  <param name="/active_user/launch_user_name" value="$(arg USER_NAME)"/>

  <!-- launch jsk-defined pr2_2dnav that respawn for change inflation_radius -->
  <include if="$(arg launch_move_base)"
           file="$(find jsk_pr2_startup)/jsk_pr2_move_base/pr2_2dnav.launch">
    <arg name="launch_look_forward" value="$(arg launch_look_forward)"/>
    <arg name="launch_navigation" value="true" />
    <arg name="use_map_keepout" value="$(arg use_map_keepout)" />
  </include>

  <!-- special start: use when launuch_move_base is false-->
  <include unless="$(arg launch_move_base)"
           file="$(find jsk_pr2_startup)/jsk_pr2_move_base/pr2_2dnav.launch">
    <arg name="launch_teleop_joystick" value="true" />
    <arg name="launch_navigation" value="false" />
  </include>

  <!-- We do not launch dynamic_tf_publisher for default anymore.
       <node name="dynamic_tf_publisher" pkg="dynamic_tf_publisher"
       type="tf_publish.py" /> -->

  <include file="$(find jsk_maps)/launch/start_map_$(arg map_frame).launch"
           if="$(arg launch_map)">
    <arg name="MACHINE" value="c2" />
    <arg name="keepout" value="$(arg use_map_keepout)" />
  </include>

  <!-- kinect node -->
  <include if="$(arg launch_kinect)"
           file="$(find jsk_pr2_startup)/jsk_pr2_sensors/kinect_head.launch" >
    <arg name="monitor_driver" value="true" />  <!-- iory 2022/05/11-->
  </include>

  <!-- logging node for PR2  -->
  <include if="$(arg launch_db)"
           file="$(find jsk_pr2_startup)/jsk_pr2_lifelog/db_client.launch" >
    <arg name="map_frame" value="$(arg map_frame)" />
    <arg name="twitter" value="$(arg launch_twitter)"/>
    <arg name="visualize_log" value="$(arg launch_visualize_log)"/>
  </include>

  <!-- look at human for PR2 -->
  <node name="look_at_human"
        pkg="jsk_pr2_startup" type="pr2-look-at-human.l">
    <remap from="~input/people_pose_array" to="/edgetpu_human_pose_estimator/output/poses"/>
  </node>

  <!-- pr2 warning -->
  <!-- battery warning -->
  <group if="$(arg launch_safety_warning)" >
    <node name="battery_warning" pkg="jsk_pr2_startup" type="battery_warning.py"/>
    <node name="battery_visualization"
          pkg="jsk_pr2_startup" type="battery_visualization.py" />
    <node name="battery_logger"
          pkg="jsk_pr2_startup" type="battery_logger.py">
      <rosparam subst_value="true">
        loggers:
          - type: file
            out_dir: /var/log/ros/battery
          - type: dweet
            prefix: pr2-battery
      </rosparam>
    </node>
  </group>

  <!-- mjpeg_server for web -->
  <node if="$(arg launch_mjpeg_server)"
        pkg="mjpeg_server" type="mjpeg_server"  name="mjpeg_server" output="screen">
    <param name="port" type="int" value="8080" />
  </node>

  <!-- for gripper sensor actions -->
  <group if="$(arg launch_gripper_sensor)">
    <group ns="l_gripper_sensor_controller">
      <param name="publish_skip" value="100" /> <!--10Hz-->
    </group>
    <group ns="r_gripper_sensor_controller">
      <param name="publish_skip" value="100" /> <!--10Hz-->
    </group>
    <include file="$(find pr2_gripper_sensor_action)/launch/pr2_gripper_sensor_actions.launch" />
  </group>

  <!-- for virtual force publisher-->
  <group if="$(arg launch_virtual_force)">
    <include file="$(find virtual_force_publisher)/launch/dualarm_virtual_force_publisher.launch" />
  </group>

  <!-- for iPad or android apps -->
  <include if="$(arg launch_jsk_pcl)"
           file="$(find jsk_pcl_ros)/launch/pointcloud_screenpoint.launch" >
    <arg name="image" value="/kinect_head/rgb" />
    <arg name="cloud_machine" value="c2" />
    <arg name="camera_info" value="camera_info_input_mux"/>
    <arg name="points" value="points_input_mux"/>
  </include>
  <include if="$(arg launch_tablet)"
           file="$(find jsk_pr2_startup)/jsk_pr2_sensors/tablet_startup.launch" />

  <!-- for microphone -->
  <include if="$(arg launch_microphone)"
           file="$(find jsk_pr2_startup)/jsk_pr2_lifelog/pr2_microphone.launch"/>

  <!-- joy mux -->
  <node machine="c2" pkg="topic_tools" type="mux" name="multiple_joystick_mux"
        respawn="true" args="/joy /joy_org /joy_other" >
    <remap from="mux" to="multiple_joystick_mux"/>
  </node>

  <include if="$(arg launch_teleoperation)"
           file="$(find jsk_pr2_startup)/jsk_pr2_sensors/pr2_teleop_robot.launch" />
  <include if="$(arg slow_camera_framerate)"
           file="$(find jsk_pr2_startup)/jsk_pr2_sensors/camera_framerate.launch" />

  <include if="$(arg launch_c3_startup)"
	   file="$(find jsk_pr2_startup)/jsk_pr2_sensors/pr2_remote_startup.launch">
    <arg name="MACHINE" value="c3"/>
    <arg name="launch_battery" value="true"/>
  </include>
  <include if="$(arg launch_people_detection)"
           file="$(find jsk_pr2_startup)/jsk_pr2_sensors/people_detection.launch" />

  <include if="$(arg launch_moveit)"
           file="$(find jsk_pr2_startup)/jsk_pr2_moveit/start_pr2_moveit.launch" />

  <node if="$(arg launch_reset_motors)"
        name="pr2_reset_motors" pkg="jsk_pr2_startup" type="pr2_reset_motors.py">
    <rosparam>
      watch_duration: 30
    </rosparam>
  </node>

  <include if="$(arg launch_dialogflow_task_executive)"
           file="$(find dialogflow_task_executive)/launch/dialogflow_task_executive.launch">
    <arg name="run_app_manager" value="false" />
  </include>

  <include if="$(arg launch_gdrive_server_c1)"
           file="$(find jsk_pr2_startup)/jsk_pr2_lifelog/pr2_gdrive_server.launch">
    <arg name="respawn" value="true" />
    <arg name="machine" value="localhost" />
    <arg name="node_name" value="gdrive_server" />
  </include>

  <include if="$(arg launch_gdrive_server_c2)"
           file="$(find jsk_pr2_startup)/jsk_pr2_lifelog/pr2_gdrive_server.launch">
    <arg name="respawn" value="true" />
    <arg name="machine" value="c2" />
    <arg name="node_name" value="gdrive_server_c2" />
  </include>

  <node pkg="jsk_robot_startup" type="finish_launch_sound.py"
        machine="c2"
        name="finish_launch_sound" />

  <!-- check if room light is on -->
  <node name="check_room_light" pkg="jsk_robot_startup" type="check_room_light.py">
    <remap from="~input" to="/kinect_head/rgb/image_raw" />
  </node>

  <node name="audible_warning"
        pkg="jsk_tools" type="audible_warning.py"
        clear_params="true"
        output="screen" >
    <rosparam command="load" file="$(find jsk_pr2_startup)/jsk_pr2_warning/warning_blacklist.yaml" />
    <rosparam>
      run_stop_topic: /power_board/state
      run_stop_condition: "m.run_stop is False"
      seconds_to_start_speaking: 60
      speak_interval: 600
      ignore_time_after_runstop_is_enabled: 5.0
      ignore_time_after_runstop_is_disabled: 5.0
    </rosparam>
  </node>

  <group ns="audible_warning" >
    <!-- tweet with image -->
    <node name="publish_to_tweet_server"
          pkg="topic_tools" type="transform"
          args="/audible_warning/output/original_text
                /tweet_image_server/tweet/goal
                rostwitter/TweetActionGoal
                --wait-for-start
                'rostwitter.msg.TweetActionGoal(goal=rostwitter.msg.TweetGoal(text=&quot;[Audible warning] &quot; + m.data, image=True, image_topic_name=&quot;/edgetpu_human_pose_estimator/output/image&quot;))'
                --import rostwitter">
    </node>
  </group>

  <node name="sanity_diagnostics"
        pkg="jsk_tools" type="sanity_diagnostics.py" >
    <rosparam command="load" file="$(find jsk_pr2_startup)/jsk_pr2_warning/sanity_targets.yaml" />
    <rosparam subst_value="true">
      duration: 60
    </rosparam>
  </node>

  <!-- send email by rostopic -->
  <node name="email_topic" pkg="jsk_robot_startup" type="email_topic.py" output="screen">
    <rosparam>
      email_info: /var/lib/robot/email_topic.yaml
    </rosparam>
  </node>

  <!-- send email, twitter with smach -->
  <node name="smach_to_mail_server" pkg="jsk_robot_startup" type="smach_to_mail.py" output="screen">
    <rosparam>
      email_info: /var/lib/robot/email_topic.yaml
    </rosparam>
  </node>

</launch>
